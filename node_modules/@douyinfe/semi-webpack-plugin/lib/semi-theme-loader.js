"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const loader_utils_1 = __importDefault(require("loader-utils"));
const enhanced_resolve_1 = __importDefault(require("enhanced-resolve"));
const componentName_1 = __importDefault(require("./componentName"));
function SemiThemeLoader(source) {
    var _a;
    const query = loader_utils_1.default.getOptions ? loader_utils_1.default.getOptions(this) : loader_utils_1.default.parseQuery(this.query);
    const cssLayer = (_a = query.cssLayer) !== null && _a !== void 0 ? _a : false;
    const theme = query.name || '@douyinfe/semi-theme-default';
    // always inject
    const scssVarStr = `@import "~${theme}/scss/index.scss";\n`;
    // inject once
    const cssVarStr = `@import "~${theme}/scss/global.scss";\n`;
    let animationStr = `@import "~${theme}/scss/animation.scss";\n`;
    try {
        enhanced_resolve_1.default.sync(this.context, `${theme}/scss/animation.scss`);
    }
    catch (e) {
        animationStr = ''; // fallback to empty string
    }
    const shouldInject = source.includes('semi-base');
    let fileStr = source;
    let componentVariables;
    try {
        componentVariables = enhanced_resolve_1.default.sync(this.context, `${theme}/scss/local.scss`);
    }
    catch (e) {
    }
    if (query.include || query.variables || componentVariables) {
        let localImport = '';
        if (componentVariables) {
            localImport += `\n@import "~${theme}/scss/local.scss";`;
        }
        if (query.include) {
            localImport += `\n@import "${query.include}";`;
        }
        if (query.variables) {
            localImport += `\n${query.variables}`;
        }
        try {
            const regex = /(@import '.\/variables.scss';?|@import ".\/variables.scss";?)/g;
            const fileSplit = source.split(regex).filter(item => Boolean(item));
            if (fileSplit.length > 1) {
                fileSplit.splice(fileSplit.length - 1, 0, localImport);
                fileStr = fileSplit.join('');
            }
        }
        catch (error) {
        }
    }
    // inject prefix
    const prefixCls = query.prefixCls || 'semi';
    const prefixClsStr = `$prefix: '${prefixCls}';\n`;
    let finalCSS = "";
    if (shouldInject) {
        const customStr = (() => {
            let customStr = '';
            try {
                if (!enhanced_resolve_1.default.sync(this.context, `${theme}/scss/custom.scss`)) {
                    return '';
                }
                const collectAllVariablesPath = [
                    ...componentName_1.default,
                ];
                if (componentVariables) {
                    collectAllVariablesPath.push(`${theme}/scss/local.scss`);
                }
                collectAllVariablesPath.push(`${theme}/scss/custom.scss`);
                customStr = collectAllVariablesPath.map(p => {
                    return `@import "~${p}";`;
                }).join('\n') + '\n' + customStr;
            }
            catch (e) {
                customStr = ''; // fallback to empty string
            }
            return `body:not(:not(body)){${customStr}};`;
        })();
        finalCSS = `${animationStr}${cssVarStr}${scssVarStr}${prefixClsStr}${fileStr}${customStr}`;
    }
    else {
        finalCSS = `${scssVarStr}${prefixClsStr}${fileStr}`;
    }
    if (cssLayer) {
        finalCSS = `@layer semi{${finalCSS}}`;
    }
    return finalCSS;
}
exports.default = SemiThemeLoader;
//# sourceMappingURL=semi-theme-loader.js.map